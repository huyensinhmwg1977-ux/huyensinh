<!doctype html>
<html lang="vi" class="h-full">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>H·ªÜ M·∫∂T TR·ªúI - V≈® TR·ª§ R·ªòNG L·ªöN</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Exo+2:wght@300;400;700;900&display=swap" rel="stylesheet">
  <style>
    /* === C·∫§U H√åNH T·ªêI ∆ØU HI·ªÜU SU·∫§T === */
    html, body {
        width: 100%; height: 100%; margin: 0; padding: 0;
        background-color: #000;
        font-family: 'Exo 2', sans-serif;
        overflow: hidden; 
        -webkit-tap-highlight-color: transparent; /* T·∫Øt highlight m·∫∑c ƒë·ªãnh */
        user-select: none; /* NgƒÉn b√¥i ƒëen vƒÉn b·∫£n khi b·∫•m nhanh */
        touch-action: manipulation; /* T·∫ÆT ƒê·ªò TR·ªÑ 300MS QUAN TR·ªåNG */
    }

    #game-container {
        width: 100vw; height: 100vh; 
        overflow: hidden; position: relative;
        background: radial-gradient(ellipse at center, #0b0f19 0%, #000000 100%);
    }
    
    /* === SAO & THI√äN TH·∫†CH === */
    .star {
      position: absolute; background: white; border-radius: 50%;
      animation: twinkle var(--duration) ease-in-out infinite; opacity: 0.8; z-index: 0;
    }
    @keyframes twinkle { 0%, 100% { opacity: 0.3; transform: scale(1); } 50% { opacity: 1; transform: scale(1.5); } }

    .meteor {
      position: absolute; top: 0; right: 0; width: 150px; height: 2px;
      background: linear-gradient(to right, rgba(255,255,255,0) 0%, rgba(255,255,255,1) 50%, rgba(255,255,255,0) 100%);
      transform: rotate(-45deg); pointer-events: none; z-index: 10;
      opacity: 0; animation: meteorShoot 2s linear forwards;
    }
    .meteor::before {
      content: ''; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
      width: 4px; height: 4px; background: white; border-radius: 50%;
      box-shadow: 0 0 10px white, 0 0 20px cyan;
    }
    @keyframes meteorShoot {
      0% { transform: translate(100px, -100px) rotate(-45deg); opacity: 1; }
      100% { transform: translate(-150vw, 150vh) rotate(-45deg); opacity: 0; }
    }

    .orbit-ring {
      border: 1px dashed rgba(255, 255, 255, 0.15); border-radius: 50%;
      position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
      pointer-events: none; z-index: 1;
    }
    
    /* === H√ÄNH TINH === */
    .planet-container {
      position: absolute; display: flex; justify-content: center; align-items: center;
      z-index: 50; cursor: pointer; transition: transform 0.3s ease; 
      touch-action: manipulation; /* B·∫•m l√† nh·∫≠n ngay */
    }

    .planet-shape {
      width: 100%; height: 100%; border-radius: 50%; overflow: hidden;
      box-shadow: inset -3px -3px 8px rgba(0,0,0,0.8);
      transition: all 0.5s ease; filter: brightness(0.6) saturate(0.9);
    }
    
    .planet-active { z-index: 100 !important; }
    .planet-active .planet-shape {
      filter: brightness(1.1);
      box-shadow: 0 0 15px #ffff00, 0 0 30px #ffff00;
      animation: pulseActive 1s infinite alternate;
    }
    .planet-active::before {
      content: '‚ñº'; position: absolute; top: -70%; left: 50%; transform: translateX(-50%);
      color: yellow; animation: bounce 0.8s infinite; font-weight: 900; font-size: 1.5rem;
      text-shadow: 0 2px 0 black; pointer-events: none;
    }

    .planet-connected { pointer-events: none; }
    .planet-connected .planet-shape {
      filter: brightness(1.5) saturate(1.2); box-shadow: 0 0 30px #4ade80; transform: scale(1.05);
    }
    .planet-wrong { pointer-events: none; }
    .planet-wrong .planet-shape { filter: grayscale(1.0) brightness(0.4); box-shadow: none; }

    /* M·∫∂T TR·ªúI */
    .sun-victory .sun-shape {
        filter: brightness(2.0) saturate(1.5) !important;
        box-shadow: 0 0 100px #ff4500, 0 0 150px #ffd700 !important;
        animation: sunPulse 2s infinite alternate;
    }
    .sun-shape {
      width: 100%; height: 100%; border-radius: 50%;
      background: radial-gradient(circle at center, #ffd700, #ff8c00, #ff4500);
      box-shadow: 0 0 50px #ff4500; position: relative;
      filter: brightness(0.7); transition: all 1s ease;
    }
    .sun-detail {
        position: absolute; inset: -50%; width: 200%; height: 200%;
        background-image: radial-gradient(circle, rgba(255,0,0,0.4) 10%, transparent 20%);
        background-size: 20px 20px; animation: sunSpin 20s linear infinite; opacity: 0.6;
    }

    /* M√ÄU S·∫ÆC H√ÄNH TINH */
    .mercury-bg { background: radial-gradient(circle at 30% 30%, #e5e5e5, #737373); }
    .venus-bg { background: radial-gradient(circle at 30% 30%, #fde047, #ca8a04); }
    .earth-bg { background: radial-gradient(circle at 40% 40%, #4ade80 0%, #2563eb 60%); }
    .mars-bg { background: radial-gradient(circle at 30% 30%, #fdba74, #ea580c); }
    .jupiter-bg { background: radial-gradient(circle at 30% 30%, #ffedd5, #d97706, #92400e); }
    .saturn-bg { background: radial-gradient(circle at 30% 30%, #fef9c3, #eab308, #854d0e); }
    .uranus-bg { background: radial-gradient(circle at 30% 30%, #cffafe, #06b6d4, #155e75); }
    .neptune-bg { background: radial-gradient(circle at 30% 30%, #bae6fd, #3b82f6, #1e3a8a); }
    .moon-bg { background: radial-gradient(circle at 30% 30%, #f3f4f6, #9ca3af); }

    .planet-label {
      position: absolute; bottom: -24px; left: 50%; transform: translateX(-50%);
      font-size: 14px; color: #fff; white-space: nowrap; text-shadow: 0 2px 2px black; font-weight: 700;
      background: rgba(0,0,0,0.6); padding: 4px 8px; border-radius: 4px; pointer-events: none;
    }

    @keyframes pulseActive { from { transform: scale(1); } to { transform: scale(1.1); } }
    @keyframes bounce { 0% { transform: translate(-50%, 0); } 50% { transform: translate(-50%, -10px); } 100% { transform: translate(-50%, 0); } }
    @keyframes sunSpin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    @keyframes sunPulse { from { transform: scale(1); } to { transform: scale(1.1); } }

    /* === UI C∆† B·∫¢N === */
    .ui-layer { position: fixed; top: 0; left: 0; width: 100%; z-index: 900; pointer-events: none; }
    .pointer-events-auto { pointer-events: auto; }

    #login-screen {
        position: fixed; inset: 0; z-index: 9999;
        background: radial-gradient(circle, #1e3a8a 0%, #000000 100%);
        display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px;
    }
    .glass-panel {
      background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255,255,255,0.2);
      backdrop-filter: blur(10px);
    }
    
    #quiz-modal {
        position: fixed !important; top: 0; left: 0; right: 0; bottom: 0;
        width: 100vw; height: 100vh;
        background-color: rgba(0, 0, 0, 0.7); z-index: 10000; 
        backdrop-filter: blur(5px);
    }

    /* === [NEW DESIGN] QUIZ PANEL PH·∫¢N H·ªíI NHANH === */
    
    .quiz-modern-panel {
      background: transparent;
      position: relative;
      width: 95%; max-width: 800px; max-height: 90vh;
      overflow-y: auto; 
    }

    .question-box {
        background: #ffffff;
        border-top: 6px solid #3b82f6; 
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        text-align: center;
    }

    .question-text {
        color: #dc2626; /* ƒê·ªé */
        font-weight: 900;
        font-size: 1.5rem;
    }

    /* --- N√öT ƒê√ÅP √ÅN (T·ªêI ∆ØU C·∫¢M ·ª®NG) --- */
    .answer-btn-modern {
      width: 100%; text-align: center; 
      padding: 20px;
      
      background: #f8fafc;
      color: #334155; 
      
      border: 1px solid #cbd5e1;
      border-radius: 10px; 
      box-shadow: 0 6px 0 #94a3b8;
      
      font-weight: 700; font-size: 18px; 
      cursor: pointer;
      
      /* QUAN TR·ªåNG: TƒÉng t·ªëc ƒë·ªô ph·∫£n h·ªìi */
      transition: transform 0.05s ease-out, box-shadow 0.05s ease-out; /* Nhanh h∆°n */
      position: relative;
      touch-action: manipulation; /* Lo·∫°i b·ªè delay 300ms tr√™n mobile */
      -webkit-user-select: none; /* NgƒÉn ch·ªçn vƒÉn b·∫£n khi b·∫•m nhanh */
      user-select: none;
    }
    
    /* Hi·ªáu ·ª©ng b·∫•m "l√∫n" t·ª©c th√¨ */
    .answer-btn-modern:active { 
        transform: translateY(6px) !important; 
        box-shadow: 0 0 0 #94a3b8 !important; 
    }
    
    /* Tr·∫°ng th√°i ƒê√∫ng/Sai */
    .answer-btn-modern.correct { 
        background: #22c55e !important; 
        border-color: #16a34a !important; 
        box-shadow: 0 6px 0 #14532d !important;
        color: white !important; 
    }
    .answer-btn-modern.correct:active { box-shadow: 0 0 0 #14532d !important; }

    .answer-btn-modern.wrong { 
        background: #ef4444 !important; 
        border-color: #dc2626 !important; 
        box-shadow: 0 6px 0 #991b1b !important;
        color: white !important; 
    }
    .answer-btn-modern.wrong:active { box-shadow: 0 0 0 #991b1b !important; }


    /* N√∫t c√¢u ti·∫øp theo */
    .next-btn-modern {
        width: 100%;
        margin-top: 20px;
        padding: 15px;
        background: #2563eb; 
        color: white;
        font-weight: 900; text-transform: uppercase;
        border: none; border-radius: 8px;
        box-shadow: 0 4px 10px rgba(37, 99, 235, 0.5);
        font-size: 18px;
        
        /* T·ªëi ∆∞u ph·∫£n h·ªìi */
        transition: transform 0.05s;
        touch-action: manipulation;
    }
    .next-btn-modern:active { 
        transform: scale(0.95); 
    }

    .center-btn {
        position: fixed; bottom: 20px; right: 20px; z-index: 900;
        background: rgba(29, 78, 216, 0.9); color: white;
        width: 50px; height: 50px; border-radius: 50%;
        display: flex; align-items: center; justify-content: center;
        border: 2px solid white; box-shadow: 0 0 15px rgba(37, 99, 235, 0.5);
        font-size: 24px; cursor: pointer; pointer-events: auto;
    }

    #universe-wrapper { position: relative; overflow: hidden; min-width: 100vw; min-height: 100vh; }
    #stars-in-universe { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 0; }

    /* === RESPONSIVE MOBILE === */
    @media (min-width: 769px) {
        .quiz-options-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
    }

    @media (max-width: 768px) {
        /* Gi·∫£m font ch·ªØ ƒëi -2px */
        body { font-size: 14px !important; } 
        .title-font { font-size: 1.8rem !important; }
        
        .quiz-modern-panel { width: 95%; max-height: 85vh; }
        .question-box { padding: 15px; margin-bottom: 15px; }
        
        /* Gi·∫£m nh·∫π size c√¢u h·ªèi tr√™n mobile cho v·ª´a v·∫∑n */
        .question-text { font-size: 1.25rem !important; line-height: 1.4; } 
        
        .quiz-options-grid {
            display: flex; flex-direction: column; gap: 12px;
        }
        
        /* N√∫t ƒë√°p √°n mobile */
        .answer-btn-modern { 
            padding: 16px; 
            font-size: 15px; 
            box-shadow: 0 4px 0 #94a3b8; /* Gi·∫£m ƒë·ªô cao b√≥ng 3D ch√∫t cho g·ªçn */
        }
        .answer-btn-modern:active { transform: translateY(4px) !important; }
        
        #hud-player, #hud-score, #target-planet { font-size: 12px !important; }
        .planet-label { font-size: 10px !important; }
    }

  </style>
 </head>
 <body class="text-white">

  <div id="login-screen">
      <h1 class="title-font text-4xl md:text-6xl text-blue-500 font-black mb-6 text-center tracking-wider drop-shadow-[0_0_20px_rgba(59,130,246,0.8)]">H·ªÜ M·∫∂T TR·ªúI</h1>
      <div class="bg-white p-6 rounded-2xl w-full max-w-sm text-center border-4 border-blue-600 shadow-2xl">
          <input type="text" id="username" placeholder="Nh·∫≠p t√™n phi h√†nh gia..." class="w-full bg-gray-100 border-2 border-blue-300 rounded-xl p-4 text-blue-900 focus:border-blue-600 focus:outline-none font-bold text-center mb-4 text-lg placeholder-gray-400">
          <button onclick="startGame()" class="w-full bg-red-600 hover:bg-red-500 text-white font-black py-4 rounded-xl border-b-4 border-red-800 active:border-b-0 active:translate-y-1 transition-all uppercase tracking-widest text-lg shadow-lg" style="touch-action: manipulation;">
              KH·ªûI H√ÄNH üöÄ
          </button>
      </div>
  </div>

  <div id="game-container" class="hidden">
      <div id="meteor-container" style="position: fixed; inset: 0; width: 100%; height: 100%; pointer-events: none;"></div>

      <div class="ui-layer p-2 flex justify-between items-start">
          <div class="pointer-events-auto flex flex-col items-start gap-2">
              <div class="glass-panel px-3 py-2 rounded-lg border-l-4 border-blue-500 bg-gray-900/50">
                  <div class="flex items-center gap-3">
                      <div>
                          <div class="text-[10px] text-gray-300 uppercase font-bold">Phi h√†nh gia</div>
                          <div id="hud-player" class="font-bold text-white text-sm truncate max-w-[100px]">...</div>
                      </div>
                      <div class="h-8 w-px bg-gray-500"></div>
                      <div>
                          <div class="text-[10px] text-gray-300 uppercase font-bold">ƒêi·ªÉm s·ªë</div>
                          <div id="hud-score" class="font-bold text-yellow-400 text-xl title-font">0</div>
                      </div>
                  </div>
              </div>

              <div id="end-game-controls" class="hidden flex gap-2 animate-bounce">
                  <button onclick="exitGame()" class="bg-gray-600 text-xs font-bold px-3 py-2 rounded border border-gray-400 shadow">üö™ Tho√°t</button>
                  <button onclick="restartGame()" class="bg-blue-600 text-xs font-bold px-3 py-2 rounded border border-blue-400 shadow">üîÑ Ch∆°i l·∫°i</button>
              </div>
          </div>
          
          <div id="instruction-box" class="glass-panel px-4 py-2 rounded-full hidden pointer-events-auto border-2 border-red-500 bg-gray-900/80 mr-2 mt-1 max-w-[200px] shadow-lg shadow-red-500/20">
              <div class="text-red-400 font-black text-[10px] uppercase tracking-wide">üëâ T√åM M·ª§C TI√äU:</div> 
              <div id="target-planet" class="text-white font-bold text-sm truncate"></div>
          </div>
      </div>

      <div id="universe-wrapper">
          <div id="stars-in-universe"></div>
          <div id="solar-system" class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-0 h-0"></div>
      </div>
  </div>

  <div id="recenter-btn" class="center-btn hidden" onclick="centerView()"> üéØ</div>

  <div id="quiz-modal" class="hidden flex items-center justify-center">
      <div class="quiz-modern-panel">
          <button onclick="closeQuiz()" class="absolute top-0 right-0 m-4 text-gray-500 hover:text-red-600 text-3xl font-black z-50 transition-colors" style="touch-action: manipulation;">&times;</button>
          
          <div class="question-box">
              <div class="text-sm font-bold text-gray-400 uppercase tracking-widest mb-1">T√çN HI·ªÜU T·ª™: <span id="quiz-planet" class="text-blue-600">PLANET</span></div>
              <p id="quiz-question" class="question-text"></p>
          </div>
          
          <div id="quiz-options" class="quiz-options-grid"></div>
          
          <div id="quiz-feedback" class="hidden mt-4 text-center font-black text-lg p-3 rounded-xl border-2 shadow-sm bg-white"></div>
          
          <button id="btn-next-question" onclick="nextQuestion()" class="next-btn-modern hidden">
              C√ÇU TI·∫æP THEO ‚û°
          </button>
      </div>
  </div>

  <script>
    const questions = [
      { id: 'mercury', name: 'Sao Th·ªßy', q: 'C√¢u 1: Trong GIMP, b·∫£ng ch·ªçn n√†o d√πng ƒë·ªÉ tinh ch·ªânh m√†u s·∫Øc?', a: ['A. Tools', 'B. Filters', 'C. Colors', 'D. Windows'], c: 2 },
      { id: 'venus', name: 'Sao Kim', q: 'C√¢u 2: C√¥ng c·ª• n√†o t·∫°o v√πng ch·ªçn h√¨nh ch·ªØ nh·∫≠t?', a: ['A. Ellipse Select', 'B. Rectangle Select', 'C. Free Select', 'D. Fuzzy Select'], c: 1 },
      { id: 'earth', name: 'Tr√°i ƒê·∫•t', q: 'C√¢u 3: Tham s·ªë Chroma trong Hue-Chroma ch·ªânh g√¨?', a: ['A. ƒê·ªô s√°ng', 'B. T√¥ng m√†u', 'C. ƒê·ªô b√£o h√≤a m√†u', 'D. ƒê·ªô t∆∞∆°ng ph·∫£n'], c: 2 },
      { id: 'moon', name: 'M·∫∑t TrƒÉng', q: 'C√¢u 4: C√¥ng c·ª• ch·ªçn v√πng d·ª±a tr√™n m√†u s·∫Øc gi·ªëng nhau?', a: ['A. Rectangle Select', 'B. Select by Color', 'C. Free Select', 'D. Fuzzy Select'], c: 3 },
      { id: 'mars', name: 'Sao H·ªèa', q: 'C√¢u 5: L·ªánh Brightness-Contrast d√πng ƒë·ªÉ l√†m g√¨?', a: ['A. C·∫Øt ·∫£nh', 'B. Xoay ·∫£nh', 'C. ƒê·ªïi k√≠ch th∆∞·ªõc', 'D. Ch·ªânh ƒë·ªô s√°ng/t∆∞∆°ng ph·∫£n'], c: 3 },
      { id: 'jupiter', name: 'Sao M·ªôc', q: 'C√¢u 6: ·∫¢nh b·ªã "√°m xanh", d√πng g√¨ ƒë·ªÉ c√¢n b·∫±ng?', a: ['A. Brightness-Contrast', 'B. Color Balance', 'C. Hue-Chroma', 'D. Threshold'], c: 1 },
      { id: 'saturn', name: 'Sao Th·ªï', q: 'C√¢u 7: Fuzzy Select kh√°c g√¨ Select by Color?', a: ['A. Fuzzy ch·ªçn v√πng li√™n t·ª•c', 'B. Fuzzy ch·ªçn v√πng b·∫•t k·ª≥', 'C. Fuzzy ch·ªçn h√¨nh kh·ªëi', 'D. Fuzzy ch·ªâ ch·ªçn m√†u tr·∫Øng'], c: 0 },
      { id: 'uranus', name: 'Sao Thi√™n V∆∞∆°ng', q: 'C√¢u 8: Ch·ªçn v·∫≠t th·ªÉ ph·ª©c t·∫°p d√πng c√¥ng c·ª• n√†o?', a: ['A. Rectangle Select', 'B. Ellipse Select', 'C. Free Select', 'D. Color Picker'], c: 2 },
      { id: 'neptune', name: 'Sao H·∫£i V∆∞∆°ng', q: 'C√¢u 9: ƒê·ªÉ m√†u r·ª±c r·ª° h∆°n trong Hue-Chroma, tƒÉng g√¨?', a: ['A. Hue', 'B. Lightness', 'C. Gi·∫£m Lightness', 'D. Chroma'], c: 3 },
      { id: 'sun', name: 'M·∫∑t Tr·ªùi', q: 'C√¢u 10: C√¥ng c·ª• di chuy·ªÉn h√¨nh ·∫£nh?', a: ['A. Move Tool', 'B. Crop Tool', 'C. Rotate Tool', 'D. Scale Tool'], c: 0 }
    ];

    const planetConfig = {
        sun:     { ratio: 0.01, size: 0.14, speed:0.001,     color: 'sun', label: 'M·∫∑t Tr·ªùi' },
        mercury: { ratio: 0.14, size: 0.04, speed: 0.046,  color: 'mercury-bg', label: 'Sao Th·ªßy' },
        venus:   { ratio: 0.28, size: 0.05, speed: 0.0020, color: 'venus-bg',   label: 'Sao Kim' },
        earth:   { ratio: 0.38, size: 0.06, speed: 0.023, color: 'earth-bg',   label: 'Tr√°i ƒê·∫•t' },
        mars:    { ratio: 0.46, size: 0.05, speed: 0.02,  color: 'mars-bg',    label: 'Sao H·ªèa' },
        jupiter: { ratio: 0.58, size: 0.10, speed: 0.018, color: 'jupiter-bg', label: 'Sao M·ªôc' },
        saturn:  { ratio: 0.68, size: 0.09, speed: 0.015, color: 'saturn-bg',  label: 'Sao Th·ªï', ring: true },
        uranus:  { ratio: 0.78, size: 0.07, speed: 0.022, color: 'uranus-bg',  label: 'Sao Thi√™n V∆∞∆°ng' },
        neptune: { ratio: 0.90, size: 0.07, speed: 0.02, color: 'neptune-bg', label: 'Sao H·∫£i V∆∞∆°ng' }
    };
    
    const orbitExpand = 1.8; 
    const moonConfig = { size: 0.3, speed: 0.05, dist: 1.8 };

    let state = {
        playerName: '', score: 0, currentQ: 0,
        answered: new Set(), angles: {}, moving: {}, 
        radiusBase: 0
    };

    function init() {
        setInterval(createMeteor, 3000); 
        Object.keys(planetConfig).forEach(k => {
            state.angles[k] = Math.random() * Math.PI * 2;
            state.moving[k] = true;
        });
        state.angles.moon = 0; state.moving.moon = true;
        renderSolarSystem();
        window.addEventListener('resize', resizeSystem);
        setTimeout(resizeSystem, 100);
        requestAnimationFrame(gameLoop);
    }

    function renderSolarSystem() {
        const system = document.getElementById('solar-system');
        system.innerHTML = '<div id="sun-center-point" style="position:absolute;width:1px;height:1px;"></div>';
        Object.keys(planetConfig).forEach((key) => {
            const cfg = planetConfig[key];
            if (key !== 'sun') {
                const ring = document.createElement('div');
                ring.className = 'orbit-ring';
                ring.id = `ring-${key}`;
                system.appendChild(ring);
            }
            const pDiv = document.createElement('div');
            pDiv.className = 'planet-container';
            pDiv.id = `planet-${key}`;
            pDiv.dataset.id = key;
            pDiv.onclick = (e) => handlePlanetClick(e, key);
            let shapeHTML = '';
            if (key === 'sun') {
                 shapeHTML = `<div class="sun-shape" id="planet-sun-shape"><div class="sun-detail"></div></div>`;
            } else if (cfg.ring) {
                 shapeHTML = `
                    <div style="position: relative; width: 100%; height: 100%;">
                        <div class="planet-shape ${cfg.color}" style="z-index: 2;"></div>
                        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 160%; height: 40%; border: 4px solid rgba(220, 200, 150, 0.6); border-radius: 50%;"></div>
                    </div>`;
            } else {
                shapeHTML = `<div class="planet-shape ${cfg.color}"></div>`;
            }
            pDiv.innerHTML = shapeHTML + `<div class="planet-label">${cfg.label}</div>`;
            system.appendChild(pDiv);
            if (key === 'earth') {
                const mDiv = document.createElement('div');
                mDiv.id = 'planet-moon';
                mDiv.className = 'planet-container';
                mDiv.dataset.id = 'moon';
                mDiv.onclick = (e) => handlePlanetClick(e, 'moon');
                mDiv.innerHTML = `<div class="planet-shape moon-bg"></div><div class="planet-label" style="font-size: 8px; bottom: -12px">M.TrƒÉng</div>`;
                system.appendChild(mDiv); 
            }
        });
    }

    function resizeSystem() {
        const w = window.innerWidth;
        const h = window.innerHeight;
        const minDim = Math.min(w, h);
        const isMobile = w < 768;
        const mobileScaleFactor = isMobile ? 0.9 : 1.0; 
        
        state.radiusBase = minDim < 600 ? minDim * 0.6 : minDim / 2; 
        const maxOrbit = state.radiusBase * planetConfig.neptune.ratio * orbitExpand;
        const totalSize = (maxOrbit * 2) + 400; 
        const wrapper = document.getElementById('universe-wrapper');
        wrapper.style.width = totalSize + 'px';
        wrapper.style.height = totalSize + 'px';
        
        createUniverseStars();

        const baseExpand = 1.5; 
        const sizeExpand = baseExpand * mobileScaleFactor;

        Object.keys(planetConfig).forEach(key => {
            if (key !== 'sun') {
                const r = state.radiusBase * planetConfig[key].ratio * orbitExpand;
                const ring = document.getElementById(`ring-${key}`);
                if (ring) { ring.style.width = (r * 2) + 'px'; ring.style.height = (r * 2) + 'px'; }
            }
            const pSize = state.radiusBase * planetConfig[key].size * 2 * sizeExpand;
            const pDiv = document.getElementById(`planet-${key}`);
            if (pDiv) { pDiv.style.width = pSize + 'px'; pDiv.style.height = pSize + 'px'; }
        });
        const earthSize = state.radiusBase * planetConfig.earth.size * 2 * sizeExpand;
        const moonSize = earthSize * moonConfig.size;
        const mDiv = document.getElementById('planet-moon');
        if (mDiv) { mDiv.style.width = moonSize + 'px'; mDiv.style.height = moonSize + 'px'; }
    }

    function createUniverseStars() {
        const c = document.getElementById('stars-in-universe');
        c.innerHTML = '';
        for(let i=0; i<3000; i++) {
            const s = document.createElement('div');
            s.className = 'star';
            s.style.left = Math.random()*100 + '%';
            s.style.top = Math.random()*100 + '%';
            const size = Math.random()*2.5 + 0.5;
            s.style.width = size+'px'; s.style.height = size+'px';
            s.style.setProperty('--duration', (Math.random()*3+2)+'s');
            c.appendChild(s);
        }
    }

    function gameLoop() {
        const w = window.innerWidth;
        const isMobile = w < 768;
        const mobileScaleFactor = isMobile ? 0.9 : 1.0; 
        const sizeExpand = 1.5 * mobileScaleFactor;

        Object.keys(planetConfig).forEach(key => {
            if (key === 'sun') return;
            if (state.moving[key]) state.angles[key] += planetConfig[key].speed;
            const r = state.radiusBase * planetConfig[key].ratio * orbitExpand;
            const x = Math.cos(state.angles[key]) * r;
            const y = Math.sin(state.angles[key]) * r;
            const pDiv = document.getElementById(`planet-${key}`);
            if (pDiv) pDiv.style.transform = `translate(${x}px, ${y}px)`;
            if (key === 'earth') {
                if (state.moving.moon && state.moving.earth) state.angles.moon += moonConfig.speed;
                const rMoon = (state.radiusBase * planetConfig.earth.size * sizeExpand) * moonConfig.dist + 20; 
                const mx = x + Math.cos(state.angles.moon) * rMoon;
                const my = y + Math.sin(state.angles.moon) * rMoon;
                const mDiv = document.getElementById('planet-moon');
                if (mDiv) mDiv.style.transform = `translate(${mx}px, ${my}px)`;
            }
        });
        requestAnimationFrame(gameLoop);
    }

    function centerView() {
        const sunPoint = document.getElementById('solar-system');
        if(sunPoint) {
            sunPoint.scrollIntoView({ behavior: 'smooth', block: 'center', inline: 'center' });
        }
    }

    function startGame() {
        const name = document.getElementById('username').value.trim();
        if (!name) return alert('Vui l√≤ng nh·∫≠p t√™n!');
        state.playerName = name;
        document.getElementById('login-screen').style.display = 'none';
        document.getElementById('game-container').classList.remove('hidden'); 
        document.getElementById('recenter-btn').classList.remove('hidden');
        document.getElementById('hud-player').textContent = name;
        resizeSystem();
        setTimeout(() => { centerView(); }, 300);
        updateTarget();
    }

    function updateTarget() {
        if (state.currentQ >= questions.length) {
            endGame(); return;
        }
        const q = questions[state.currentQ];
        document.getElementById('instruction-box').classList.remove('hidden');
        document.getElementById('target-planet').textContent = q.name;
        document.querySelectorAll('.planet-container').forEach(el => el.classList.remove('planet-active'));
        const targetId = q.id; 
        const targetEl = document.getElementById(targetId === 'moon' ? 'planet-moon' : `planet-${targetId}`);
        if (targetEl) {
            targetEl.classList.add('planet-active');
            if (targetId !== 'sun') state.moving[targetId] = false;
            if (targetId === 'moon') state.moving['earth'] = false;
        }
    }

    function handlePlanetClick(e, id) {
        e.stopPropagation();
        const currentTargetId = questions[state.currentQ].id;
        if (id !== currentTargetId) {
            const el = document.getElementById(id === 'moon' ? 'planet-moon' : `planet-${id}`);
            el.style.animation = 'none'; el.offsetHeight; el.style.animation = 'bounce 0.4s ease-in-out';
            return;
        }
        openQuiz();
    }

    function openQuiz() {
        const q = questions[state.currentQ];
        document.getElementById('quiz-planet').textContent = q.name;
        document.getElementById('quiz-question').textContent = q.q;
        const optsDiv = document.getElementById('quiz-options');
        optsDiv.innerHTML = '';
        q.a.forEach((ans, idx) => {
            const btn = document.createElement('button');
            btn.className = 'answer-btn-modern'; 
            btn.textContent = ans;
            btn.onclick = () => checkAnswer(idx);
            optsDiv.appendChild(btn);
        });
        document.getElementById('quiz-feedback').className = 'hidden';
        document.getElementById('btn-next-question').classList.add('hidden'); 
        document.getElementById('quiz-modal').classList.remove('hidden');
    }

    function checkAnswer(idx) {
        const q = questions[state.currentQ];
        const btns = document.querySelectorAll('.answer-btn-modern');
        const feedback = document.getElementById('quiz-feedback');
        btns.forEach(b => b.disabled = true);
        const pid = q.id;
        const pEl = document.getElementById(pid === 'moon' ? 'planet-moon' : `planet-${pid}`);
        pEl.classList.remove('planet-active');
        
        let isCorrect = false;

        if (idx === q.c) {
            btns[idx].classList.add('correct');
            feedback.textContent = 'CH√çNH X√ÅC! TUY·ªÜT V·ªúI üöÄ';
            feedback.className = 'mt-4 text-center font-black text-lg p-3 rounded-xl bg-green-100 text-green-700 border-2 border-green-500 block shadow';
            state.score += 10;
            document.getElementById('hud-score').textContent = state.score;
            pEl.classList.add('planet-connected'); 
            if (pid === 'sun') document.getElementById('planet-sun-shape').classList.add('sun-victory');
            isCorrect = true;
        } else {
            btns[idx].classList.add('wrong');
            btns[q.c].classList.add('correct');
            feedback.textContent = 'R·∫§T TI·∫æC, SAI R·ªíI! üí•';
            feedback.className = 'mt-4 text-center font-black text-lg p-3 rounded-xl bg-red-100 text-red-700 border-2 border-red-500 block shadow';
            pEl.classList.add('planet-wrong');
        }

        const nextBtn = document.getElementById('btn-next-question');
        nextBtn.classList.remove('hidden');
        nextBtn.onclick = () => nextQuestion(isCorrect);
    }

    function nextQuestion(isCorrect) {
        closeQuiz();
        const q = questions[state.currentQ];
        const pid = q.id;
        
        if (pid !== 'sun') state.moving[pid] = true;
        if (pid === 'moon') state.moving['earth'] = true;
        
        state.currentQ++;
        updateTarget();
    }

    function closeQuiz() { 
        document.getElementById('quiz-modal').classList.add('hidden'); 
    }

    function endGame() {
        document.getElementById('instruction-box').classList.add('hidden');
        document.getElementById('end-game-controls').classList.remove('hidden');
        centerView(); 
    }
    function exitGame() { location.reload(); }
    function restartGame() { location.reload(); }

    function createMeteor() {
        const container = document.getElementById('meteor-container');
        const m = document.createElement('div');
        m.className = 'meteor';
        const top = Math.random() * 50; 
        const right = Math.random() * 30; 
        m.style.top = top + '%';
        m.style.right = right + '%';
        container.appendChild(m);
        setTimeout(() => { if (container.contains(m)) container.removeChild(m); }, 2500);
    }

    init();
  </script>
 </body>
</html>
