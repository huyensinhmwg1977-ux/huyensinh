<!doctype html>
<html lang="vi" class="h-full">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>H·ªÜ M·∫∂T TR·ªúI - COMPACT MODE</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Exo+2:wght@300;400;700;900&display=swap" rel="stylesheet">
  <style>
    /* === C·∫§U H√åNH C∆† B·∫¢N === */
    html, body {
        width: 100%; height: 100%; margin: 0; padding: 0;
        background-color: #000;
        font-family: 'Exo 2', sans-serif;
        overflow: hidden; 
        -webkit-tap-highlight-color: transparent;
        user-select: none;
    }

    #game-container {
        width: 100vw; height: 100vh; 
        overflow: auto; /* Cho ph√©p cu·ªôn */
        position: relative;
        background: radial-gradient(ellipse at center, #05050a 0%, #000000 100%);
        -webkit-overflow-scrolling: touch; 
        cursor: grab;
    }
    #game-container:active { cursor: grabbing; }
    
    /* === SAO N·ªÄN === */
    .star {
      position: absolute; background: white; border-radius: 50%;
      opacity: 0.8; z-index: 0;
    }

    .orbit-ring {
      border: 1px solid rgba(255, 255, 255, 0.08);
      border-radius: 50%;
      position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
      pointer-events: none; z-index: 1;
    }
    
    /* === H√ÄNH TINH === */
    .planet-container {
      position: absolute; 
      display: flex; justify-content: center; align-items: center;
      z-index: 50; cursor: pointer; 
      transition: transform 0.1s linear; 
      touch-action: manipulation;
      min-width: 70px; min-height: 70px; 
    }

    .planet-shape {
      border-radius: 50%; 
      box-shadow: inset -3px -3px 8px rgba(0,0,0,0.8);
      transition: all 0.5s ease; 
      filter: brightness(0.9);
      position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
    }
    
    .planet-active { z-index: 100 !important; }
    .planet-active .planet-shape {
      filter: brightness(1.3);
      box-shadow: 0 0 20px #ffff00;
    }
    .planet-active::before {
      content: '‚ñº'; position: absolute; top: -25px; left: 50%; transform: translateX(-50%);
      color: #fbbf24; animation: bounce 0.8s infinite; font-weight: 900; font-size: 1.8rem;
      text-shadow: 0 2px 0 black; pointer-events: none; z-index: 101;
    }

    .planet-connected .planet-shape {
      filter: brightness(1.2); box-shadow: 0 0 25px #22c55e; 
    }
    .planet-wrong .planet-shape { filter: grayscale(1.0) brightness(0.3); }

    /* === M·∫∂T TR·ªúI === */
    .sun-shape {
      border-radius: 50%;
      background: radial-gradient(circle at center, #fffbeb, #fbbf24, #d97706);
      box-shadow: 0 0 40px #d97706; 
      position: relative;
      filter: brightness(1.0); 
      transition: all 1s ease;
      position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
    }
    
    .sun-shape.sun-victory {
        filter: brightness(1.3) !important;
        box-shadow: 0 0 80px 30px #f59e0b, 0 0 120px 50px rgba(251, 191, 36, 0.4) !important;
        z-index: 999;
        animation: sunBreathing 3s infinite alternate ease-in-out !important;
    }

    @keyframes sunBreathing {
        from { transform: translate(-50%, -50%) scale(1.0); }
        to { transform: translate(-50%, -50%) scale(1.1); }
    }

    /* M√ÄU S·∫ÆC H√ÄNH TINH */
    .mercury-bg { background: radial-gradient(circle at 30% 30%, #a3a3a3, #525252); }
    .venus-bg { background: radial-gradient(circle at 30% 30%, #fde047, #d97706); }
    .earth-bg { background: radial-gradient(circle at 40% 40%, #22d3ee 0%, #1d4ed8 50%, #1e1b4b 100%); }
    .mars-bg { background: radial-gradient(circle at 30% 30%, #fdba74, #9a3412); }
    .jupiter-bg { background: radial-gradient(circle at 30% 30%, #ffedd5, #b45309, #78350f); }
    .saturn-bg { background: radial-gradient(circle at 30% 30%, #fef08a, #ca8a04); }
    .uranus-bg { background: radial-gradient(circle at 30% 30%, #cffafe, #06b6d4); }
    .neptune-bg { background: radial-gradient(circle at 30% 30%, #60a5fa, #1e3a8a); }
    .moon-bg { background: radial-gradient(circle at 30% 30%, #e5e7eb, #6b7280); }

    .planet-label {
      position: absolute; bottom: -12px; left: 50%; transform: translateX(-50%);
      font-size: 13px; color: #e5e7eb; white-space: nowrap; font-weight: 700;
      text-shadow: 0 1px 3px black; pointer-events: none; z-index: 60;
      opacity: 0.9;
    }

    @keyframes bounce { 0% { transform: translate(-50%, 0); } 50% { transform: translate(-50%, -10px); } 100% { transform: translate(-50%, 0); } }

    /* === UI === */
    .ui-layer { position: fixed; top: 0; left: 0; width: 100%; z-index: 900; pointer-events: none; }
    .pointer-events-auto { pointer-events: auto; }

    #login-screen {
        position: fixed; inset: 0; z-index: 9999;
        background: radial-gradient(circle, #1e3a8a 0%, #000000 100%);
        display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px;
    }
    .glass-panel {
      background: rgba(15, 23, 42, 0.85); border: 1px solid rgba(59, 130, 246, 0.4);
      backdrop-filter: blur(10px);
    }
    
    #quiz-modal {
        position: fixed !important; top: 0; left: 0; right: 0; bottom: 0;
        width: 100vw; height: 100vh;
        background-color: rgba(0, 0, 0, 0.8); z-index: 10000; 
        backdrop-filter: blur(5px);
    }

    /* === QUIZ PANEL === */
    .quiz-modern-panel {
      background: transparent; position: relative;
      width: 95%; max-width: 700px; max-height: 90vh; overflow-y: auto; 
    }

    .question-box {
        background: #ffffff; border-top: 5px solid #2563eb; border-radius: 12px;
        padding: 16px; margin-bottom: 16px; box-shadow: 0 4px 15px rgba(0,0,0,0.5); text-align: center;
    }

    .question-text { color: #dc2626; font-weight: 800; font-size: 1.3rem; }

    .answer-btn-modern {
      width: 100%; text-align: center; padding: 16px;
      background: #f1f5f9; color: #334155; 
      border: 1px solid #cbd5e1; border-radius: 10px; box-shadow: 0 4px 0 #94a3b8;
      font-weight: 700; font-size: 16px; cursor: pointer;
      transition: transform 0.05s, box-shadow 0.05s; 
      position: relative; touch-action: manipulation;
      -webkit-user-select: none; user-select: none;
    }
    .answer-btn-modern:active { transform: translateY(4px) !important; box-shadow: 0 0 0 #94a3b8 !important; }
    
    .answer-btn-modern.correct { background: #22c55e !important; border-color: #16a34a !important; box-shadow: 0 4px 0 #14532d !important; color: white !important; }
    .answer-btn-modern.correct:active { box-shadow: 0 0 0 #14532d !important; }

    .answer-btn-modern.wrong { background: #ef4444 !important; border-color: #dc2626 !important; box-shadow: 0 4px 0 #991b1b !important; color: white !important; }
    .answer-btn-modern.wrong:active { box-shadow: 0 0 0 #991b1b !important; }

    .next-btn-modern {
        width: 100%; margin-top: 15px; padding: 14px;
        background: #2563eb; color: white; font-weight: 800; text-transform: uppercase;
        border: none; border-radius: 8px; box-shadow: 0 4px 0 #1e40af;
        font-size: 16px; transition: transform 0.05s; touch-action: manipulation;
    }
    .next-btn-modern:active { transform: translateY(4px); box-shadow: none; }

    .center-btn {
        position: fixed; bottom: 20px; right: 20px; z-index: 900;
        background: rgba(37, 99, 235, 0.9); color: white;
        width: 45px; height: 45px; border-radius: 50%;
        display: flex; align-items: center; justify-content: center;
        border: 2px solid white; box-shadow: 0 0 10px rgba(37, 99, 235, 0.5);
        font-size: 20px; cursor: pointer; pointer-events: auto;
    }

    #universe-wrapper { position: relative; min-width: 100vw; min-height: 100vh; overflow: hidden; }
    #stars-in-universe { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 0; }

    /* === RESPONSIVE MOBILE === */
    @media (min-width: 769px) {
        .quiz-options-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
    }

    @media (max-width: 768px) {
        body { font-size: 12px !important; } 
        .title-font { font-size: 1.5rem !important; }
        .quiz-modern-panel { width: 95%; }
        .question-box { padding: 12px; margin-bottom: 12px; }
        .question-text { font-size: 1.1rem !important; } 
        .quiz-options-grid { display: flex; flex-direction: column; gap: 10px; }
        .answer-btn-modern { padding: 14px; font-size: 14px; }
        #hud-player, #hud-score, #target-planet { font-size: 11px !important; }
        .planet-label { font-size: 10px !important; }
    }

  </style>
 </head>
 <body class="text-white">

  <div id="login-screen">
      <h1 class="title-font text-4xl md:text-5xl text-blue-500 font-black mb-6 text-center tracking-wider drop-shadow-[0_0_20px_rgba(59,130,246,0.8)]">H·ªÜ M·∫∂T TR·ªúI</h1>
      <div class="bg-white p-5 rounded-2xl w-full max-w-xs text-center border-4 border-blue-600 shadow-2xl">
          <input type="text" id="username" placeholder="T√™n phi h√†nh gia..." class="w-full bg-gray-100 border-2 border-blue-300 rounded-xl p-3 text-blue-900 focus:border-blue-600 focus:outline-none font-bold text-center mb-4 text-base">
          <button onclick="startGame()" class="w-full bg-red-600 hover:bg-red-500 text-white font-black py-3 rounded-xl border-b-4 border-red-800 active:border-b-0 active:translate-y-1 transition-all uppercase tracking-widest text-base shadow-lg" style="touch-action: manipulation;">
              KH·ªûI H√ÄNH üöÄ
          </button>
      </div>
  </div>

  <div id="game-container" class="hidden">
      <div class="ui-layer p-2 flex justify-between items-start">
          <div class="pointer-events-auto flex flex-col items-start gap-2">
              <div class="glass-panel px-3 py-2 rounded-lg border-l-4 border-blue-500">
                  <div class="flex items-center gap-3">
                      <div>
                          <div class="text-[8px] text-gray-400 uppercase font-bold">Phi h√†nh gia</div>
                          <div id="hud-player" class="font-bold text-white text-xs truncate max-w-[80px]">...</div>
                      </div>
                      <div class="h-6 w-px bg-gray-500"></div>
                      <div>
                          <div class="text-[8px] text-gray-400 uppercase font-bold">ƒêi·ªÉm</div>
                          <div id="hud-score" class="font-bold text-yellow-400 text-lg title-font">0</div>
                      </div>
                  </div>
              </div>

              <div id="end-game-controls" class="hidden flex gap-2 animate-bounce">
                  <button onclick="exitGame()" class="bg-gray-600 text-[8px] font-bold px-3 py-2 rounded border border-gray-400 shadow">üö™ Tho√°t</button>
                  <button onclick="restartGame()" class="bg-blue-600 text-[8px] font-bold px-3 py-2 rounded border border-blue-400 shadow">üîÑ Ch∆°i l·∫°i</button>
              </div>
          </div>
          
          <div id="instruction-box" class="glass-panel px-3 py-2 rounded-full hidden pointer-events-auto border-2 border-red-500 mr-2 mt-1 shadow-lg shadow-red-500/20">
              <div class="text-red-400 font-black text-[8px] uppercase tracking-wide">üëâ T√åM:</div> 
              <div id="target-planet" class="text-white font-bold text-xs truncate"></div>
          </div>
      </div>

      <div id="universe-wrapper">
          <div id="stars-in-universe"></div>
          <div id="solar-system" class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-0 h-0"></div>
      </div>
  </div>

  <div id="recenter-btn" class="center-btn hidden" onclick="centerView()">HS </div>

  <div id="quiz-modal" class="hidden flex items-center justify-center">
      <div class="quiz-modern-panel">
          <div class="question-box">
              <div class="text-[8px] font-bold text-gray-400 uppercase tracking-widest mb-1">T√çN HI·ªÜU T·ª™: <span id="quiz-planet" class="text-blue-600">PLANET</span></div>
              <p id="quiz-question" class="question-text"></p>
          </div>
          
          <div id="quiz-options" class="quiz-options-grid"></div>
          
          <div id="quiz-feedback" class="hidden mt-3 text-center font-black text-base p-2 rounded-lg border-2 shadow-sm bg-white"></div>
          
          <button id="btn-next-question" onclick="nextQuestion()" class="next-btn-modern hidden">
              C√ÇU TI·∫æP THEO 
          </button>
      </div>
  </div>

  <script>
    const questions = [
      { id: 'mercury', name: 'Sao Th·ªßy', q: 'C√¢u 1: Trong GIMP, b·∫£ng ch·ªçn n√†o d√πng ƒë·ªÉ tinh ch·ªânh m√†u s·∫Øc?', a: ['A. Tools', 'B. Filters', 'C. Colors', 'D. Windows'], c: 2 },
      { id: 'venus', name: 'Sao Kim', q: 'C√¢u 2: C√¥ng c·ª• n√†o t·∫°o v√πng ch·ªçn h√¨nh ch·ªØ nh·∫≠t?', a: ['A. Ellipse Select', 'B. Rectangle Select', 'C. Free Select', 'D. Fuzzy Select'], c: 1 },
      { id: 'earth', name: 'Tr√°i ƒê·∫•t', q: 'C√¢u 3: Tham s·ªë Chroma trong Hue-Chroma ch·ªânh g√¨?', a: ['A. ƒê·ªô s√°ng', 'B. T√¥ng m√†u', 'C. ƒê·ªô b√£o h√≤a m√†u', 'D. ƒê·ªô t∆∞∆°ng ph·∫£n'], c: 2 },
      { id: 'moon', name: 'M·∫∑t TrƒÉng', q: 'C√¢u 4: C√¥ng c·ª• ch·ªçn v√πng d·ª±a tr√™n m√†u s·∫Øc gi·ªëng nhau?', a: ['A. Rectangle Select', 'B. Select by Color', 'C. Free Select', 'D. Fuzzy Select'], c: 3 },
      { id: 'mars', name: 'Sao H·ªèa', q: 'C√¢u 5: L·ªánh Brightness-Contrast d√πng ƒë·ªÉ l√†m g√¨?', a: ['A. C·∫Øt ·∫£nh', 'B. Xoay ·∫£nh', 'C. ƒê·ªïi k√≠ch th∆∞·ªõc', 'D. Ch·ªânh ƒë·ªô s√°ng/t∆∞∆°ng ph·∫£n'], c: 3 },
      { id: 'jupiter', name: 'Sao M·ªôc', q: 'C√¢u 6: ·∫¢nh b·ªã "√°m xanh", d√πng g√¨ ƒë·ªÉ c√¢n b·∫±ng?', a: ['A. Brightness-Contrast', 'B. Color Balance', 'C. Hue-Chroma', 'D. Threshold'], c: 1 },
      { id: 'saturn', name: 'Sao Th·ªï', q: 'C√¢u 7: Fuzzy Select kh√°c g√¨ Select by Color?', a: ['A. Fuzzy ch·ªçn v√πng li√™n t·ª•c', 'B. Fuzzy ch·ªçn v√πng b·∫•t k·ª≥', 'C. Fuzzy ch·ªçn h√¨nh kh·ªëi', 'D. Fuzzy ch·ªâ ch·ªçn m√†u tr·∫Øng'], c: 0 },
      { id: 'uranus', name: 'Sao Thi√™n V∆∞∆°ng', q: 'C√¢u 8: Ch·ªçn v·∫≠t th·ªÉ ph·ª©c t·∫°p d√πng c√¥ng c·ª• n√†o?', a: ['A. Rectangle Select', 'B. Ellipse Select', 'C. Free Select', 'D. Color Picker'], c: 2 },
      { id: 'neptune', name: 'Sao H·∫£i V∆∞∆°ng', q: 'C√¢u 9: ƒê·ªÉ m√†u r·ª±c r·ª° h∆°n trong Hue-Chroma, tƒÉng g√¨?', a: ['A. Hue', 'B. Lightness', 'C. Gi·∫£m Lightness', 'D. Chroma'], c: 3 },
      { id: 'sun', name: 'M·∫∑t Tr·ªùi', q: 'C√¢u 10: C√¥ng c·ª• di chuy·ªÉn h√¨nh ·∫£nh?', a: ['A. Move Tool', 'B. Crop Tool', 'C. Rotate Tool', 'D. Scale Tool'], c: 0 }
    ];

    // C·∫§U H√åNH COMPACT: C√ÅC H√ÄNH TINH NGO√ÄI S√ÅT L·∫†I G·∫¶N H∆†N
    const planetConfig = {
        sun:     { au: 0,    size: 80, speed: 0,        color: 'sun', label: 'M·∫∑t Tr·ªùi' },
        
        // Nh√≥m trong: GI·ªÆ SIZE X2 (ƒê√£ to s·∫µn)
        mercury: { au: 0.6,  size: 16,  speed: 0.015,    color: 'mercury-bg', label: 'Sao Th·ªßy' }, 
        venus:   { au: 0.9,  size: 32,  speed: 0.005,    color: 'venus-bg',   label: 'Sao Kim' },  
        earth:   { au: 1.3,  size: 34,  speed: 0.003,    color: 'earth-bg',   label: 'Tr√°i ƒê·∫•t' }, 
        mars:    { au: 1.8,  size: 20,  speed: 0.002,   color: 'mars-bg',    label: 'Sao H·ªèa' },  
        
        // Nh√≥m ngo√†i: K√âO G·∫¶N L·∫†I ƒê√ÅNG K·ªÇ (au gi·∫£m) nh∆∞ng SIZE V·∫™N TO
        jupiter: { au: 2.2,  size: 60,  speed: 0.0015,   color: 'jupiter-bg', label: 'Sao M·ªôc' }, // C≈© 3.5 -> 2.2
        saturn:  { au: 2.9,  size: 50,  speed: 0.005,   color: 'saturn-bg',  label: 'Sao Th·ªï', ring: true }, // C≈© 5.0 -> 2.9
        uranus:  { au: 3.5,  size: 30,  speed: 0.0002,  color: 'uranus-bg',  label: 'Sao Thi√™n V∆∞∆°ng' }, // C≈© 5.8 -> 3.5
        neptune: { au: 3.5,  size: 28,  speed: 0.0002,  color: 'neptune-bg', label: 'Sao H·∫£i V∆∞∆°ng' } // C≈© 6.8 -> 4.0
    };
    
    // M·∫∑t trƒÉng: X2 size
    const moonConfig = { size: 8, speed: 0.04, dist: 50 }; 

    let state = {
        playerName: '', score: 0, currentQ: 0,
        answered: new Set(), angles: {}, moving: {}, 
        radiusBase: 0
    };

    function init() {
        Object.keys(planetConfig).forEach(k => {
            state.angles[k] = Math.random() * Math.PI * 2;
            state.moving[k] = true;
        });
        state.angles.moon = 0; state.moving.moon = true;
        renderSolarSystem();
        window.addEventListener('resize', resizeSystem);
        setTimeout(resizeSystem, 100);
        requestAnimationFrame(gameLoop);
    }

    function renderSolarSystem() {
        const system = document.getElementById('solar-system');
        system.innerHTML = '<div id="sun-center-point" style="position:absolute;width:1px;height:1px;"></div>';
        
        Object.keys(planetConfig).forEach((key) => {
            const cfg = planetConfig[key];
            
            if (key !== 'sun') {
                const ring = document.createElement('div');
                ring.className = 'orbit-ring';
                ring.id = `ring-${key}`;
                system.appendChild(ring);
            }

            const pDiv = document.createElement('div');
            pDiv.className = 'planet-container';
            pDiv.id = `planet-${key}`;
            pDiv.dataset.id = key;
            pDiv.onclick = (e) => handlePlanetClick(e, key); 
            
            let shapeHTML = '';
            if (key === 'sun') {
                 shapeHTML = `<div class="sun-shape" id="planet-sun-shape" style="width:${cfg.size*2}px; height:${cfg.size*2}px;"><div class="sun-detail"></div></div>`;
            } else if (cfg.ring) {
                 shapeHTML = `
                    <div style="position:absolute; width:${cfg.size*2}px; height:${cfg.size*2}px; top:50%; left:50%; transform:translate(-50%,-50%);">
                        <div class="planet-shape ${cfg.color}" style="width:100%; height:100%;"></div>
                        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 180%; height: 50%; border: 6px solid rgba(200, 180, 140, 0.7); border-radius: 50%;"></div>
                    </div>`;
            } else {
                shapeHTML = `<div class="planet-shape ${cfg.color}" style="width:${cfg.size*2}px; height:${cfg.size*2}px;"></div>`;
            }
            
            pDiv.innerHTML = shapeHTML + `<div class="planet-label">${cfg.label}</div>`;
            system.appendChild(pDiv);

            if (key === 'earth') {
                const mDiv = document.createElement('div');
                mDiv.id = 'planet-moon';
                mDiv.className = 'planet-container';
                // V√πng b·∫•m m·∫∑t trƒÉng
                mDiv.style.width = '50px'; mDiv.style.height = '50px';
                mDiv.onclick = (e) => handlePlanetClick(e, 'moon');
                mDiv.innerHTML = `<div class="planet-shape moon-bg" style="width:${moonConfig.size*2}px; height:${moonConfig.size*2}px;"></div><div class="planet-label" style="bottom:-15px; font-size:10px;">M.TrƒÉng</div>`;
                system.appendChild(mDiv); 
            }
        });
    }

    function resizeSystem() {
        const baseUnit = Math.min(window.innerWidth, window.innerHeight) / 4; 
        const maxDist = baseUnit * planetConfig.neptune.au;
        const totalSize = (maxDist * 2) + 400; // Gi·∫£m l·ªÅ v√¨ ƒë√£ thu g·ªçn
        
        const wrapper = document.getElementById('universe-wrapper');
        wrapper.style.width = totalSize + 'px';
        wrapper.style.height = totalSize + 'px';
        
        createUniverseStars(totalSize);

        Object.keys(planetConfig).forEach(key => {
            if (key !== 'sun') {
                const r = baseUnit * planetConfig[key].au;
                const ring = document.getElementById(`ring-${key}`);
                if (ring) { ring.style.width = (r * 2) + 'px'; ring.style.height = (r * 2) + 'px'; }
            }
        });
        
        state.baseUnit = baseUnit; 
    }

    function createUniverseStars(size) {
        const c = document.getElementById('stars-in-universe');
        c.innerHTML = '';
        for(let i=0; i<1500; i++) {
            const s = document.createElement('div');
            s.className = 'star';
            s.style.left = Math.random()*100 + '%';
            s.style.top = Math.random()*100 + '%';
            const sz = Math.random()*2 + 1;
            s.style.width = sz+'px'; s.style.height = sz+'px';
            s.style.setProperty('--duration', (Math.random()*3+2)+'s');
            c.appendChild(s);
        }
    }

    function gameLoop() {
        if (!state.baseUnit) return requestAnimationFrame(gameLoop);

        Object.keys(planetConfig).forEach(key => {
            if (key === 'sun') return;
            if (state.moving[key]) state.angles[key] += planetConfig[key].speed;
            
            const r = state.baseUnit * planetConfig[key].au;
            const x = Math.cos(state.angles[key]) * r;
            const y = Math.sin(state.angles[key]) * r;
            
            const pDiv = document.getElementById(`planet-${key}`);
            if (pDiv) pDiv.style.transform = `translate(${x}px, ${y}px)`;
            
            if (key === 'earth') {
                if (state.moving.moon && state.moving.earth) state.angles.moon += moonConfig.speed;
                const mx = x + Math.cos(state.angles.moon) * moonConfig.dist;
                const my = y + Math.sin(state.angles.moon) * moonConfig.dist;
                
                const mDiv = document.getElementById('planet-moon');
                if (mDiv) mDiv.style.transform = `translate(${mx}px, ${my}px)`;
            }
        });
        requestAnimationFrame(gameLoop);
    }

    function centerView() {
        const sunPoint = document.getElementById('solar-system');
        if(sunPoint) {
            sunPoint.scrollIntoView({ behavior: 'smooth', block: 'center', inline: 'center' });
        }
    }

    function startGame() {
        const name = document.getElementById('username').value.trim();
        if (!name) return alert('Vui l√≤ng nh·∫≠p t√™n!');
        state.playerName = name;
        document.getElementById('login-screen').style.display = 'none';
        document.getElementById('game-container').classList.remove('hidden'); 
        document.getElementById('recenter-btn').classList.remove('hidden');
        document.getElementById('hud-player').textContent = name;
        resizeSystem();
        setTimeout(() => { centerView(); }, 300);
        updateTarget();
    }

    function updateTarget() {
        if (state.currentQ >= questions.length) {
            endGame(); return;
        }
        const q = questions[state.currentQ];
        document.getElementById('instruction-box').classList.remove('hidden');
        document.getElementById('target-planet').textContent = q.name;
        document.querySelectorAll('.planet-container').forEach(el => el.classList.remove('planet-active'));
        const targetId = q.id; 
        const targetEl = document.getElementById(targetId === 'moon' ? 'planet-moon' : `planet-${targetId}`);
        if (targetEl) {
            targetEl.classList.add('planet-active');
            if (targetId !== 'sun') state.moving[targetId] = false;
            if (targetId === 'moon') state.moving['earth'] = false;
        }
    }

    function handlePlanetClick(e, id) {
        e.stopPropagation();
        const currentTargetId = questions[state.currentQ].id;
        if (id !== currentTargetId) {
            const el = document.getElementById(id === 'moon' ? 'planet-moon' : `planet-${id}`);
            el.style.transform += " scale(1.2)";
            setTimeout(() => { el.style.transform = el.style.transform.replace(" scale(1.2)", ""); }, 100);
            return;
        }
        openQuiz();
    }

    function openQuiz() {
        const q = questions[state.currentQ];
        document.getElementById('quiz-planet').textContent = q.name;
        document.getElementById('quiz-question').textContent = q.q;
        const optsDiv = document.getElementById('quiz-options');
        optsDiv.innerHTML = '';
        q.a.forEach((ans, idx) => {
            const btn = document.createElement('button');
            btn.className = 'answer-btn-modern'; 
            btn.textContent = ans;
            btn.onclick = () => checkAnswer(idx);
            optsDiv.appendChild(btn);
        });
        document.getElementById('quiz-feedback').className = 'hidden';
        document.getElementById('btn-next-question').classList.add('hidden'); 
        document.getElementById('quiz-modal').classList.remove('hidden');
    }

    function checkAnswer(idx) {
        const q = questions[state.currentQ];
        const btns = document.querySelectorAll('.answer-btn-modern');
        const feedback = document.getElementById('quiz-feedback');
        btns.forEach(b => b.disabled = true);
        const pid = q.id;
        const pEl = document.getElementById(pid === 'moon' ? 'planet-moon' : `planet-${pid}`);
        pEl.classList.remove('planet-active');
        
        let isCorrect = false;

        if (idx === q.c) {
            btns[idx].classList.add('correct');
            feedback.textContent = 'CH√çNH X√ÅC!';
            feedback.className = 'mt-3 text-center font-black text-base p-2 rounded-lg bg-green-100 text-green-700 border-2 border-green-500 block shadow';
            state.score += 10;
            document.getElementById('hud-score').textContent = state.score;
            pEl.classList.add('planet-connected'); 
            
            if (pid === 'sun') {
                const sunShape = document.querySelector('#planet-sun .sun-shape') || document.getElementById('planet-sun-shape');
                if(sunShape) sunShape.classList.add('sun-victory');
            }
            
            isCorrect = true;
        } else {
            btns[idx].classList.add('wrong');
            btns[q.c].classList.add('correct');
            feedback.textContent = 'SAI R·ªíI!';
            feedback.className = 'mt-3 text-center font-black text-base p-2 rounded-lg bg-red-100 text-red-700 border-2 border-red-500 block shadow';
            pEl.classList.add('planet-wrong');
        }

        const nextBtn = document.getElementById('btn-next-question');
        nextBtn.classList.remove('hidden');
        nextBtn.onclick = () => nextQuestion(isCorrect);
    }

    function nextQuestion(isCorrect) {
        closeQuiz();
        const q = questions[state.currentQ];
        const pid = q.id;
        
        if (pid !== 'sun') state.moving[pid] = true;
        if (pid === 'moon') state.moving['earth'] = true;
        
        state.currentQ++;
        updateTarget();
    }

    function closeQuiz() { document.getElementById('quiz-modal').classList.add('hidden'); }
    function endGame() {
        document.getElementById('instruction-box').classList.add('hidden');
        document.getElementById('end-game-controls').classList.remove('hidden');
        centerView(); 
    }
    function exitGame() { location.reload(); }
    function restartGame() { location.reload(); }

    init();
  </script>
 </body>
</html>
